<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DeFi Strategy Recommender</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 1000px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #6c5ce7;
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }
        .btn-connect {
            background-color: #6c5ce7;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
        }
        .btn-connect:hover {
            background-color: #5649c0;
        }
        .btn-recommend {
            background-color: #00b894;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
        }
        .btn-recommend:hover {
            background-color: #00a383;
        }
        .btn-combination {
            background-color: #0984e3;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
        }
        .btn-combination:hover {
            background-color: #0870c0;
        }
        .risk-selector {
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .asset-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .recommendation-card {
            background-color: #f1f9ff;
            border-left: 5px solid #6c5ce7;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            color: #6c5ce7;
        }
        .network-alert {
            display: none;
            margin-top: 20px;
        }
        .strategy-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        .strategy-card {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }
        .strategy-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .strategy-description {
            color: #6c757d;
        }
        .yield-rate {
            font-weight: bold;
            color: #28a745;
        }
        .risk-level {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .risk-low {
            background-color: #d4edda;
            color: #155724;
        }
        .risk-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        .risk-high {
            background-color: #f8d7da;
            color: #721c24;
        }
        .vs-hodl-positive {
            color: #28a745;
        }
        .vs-hodl-negative {
            color: #dc3545;
        }
        .strategy-tabs {
            margin-bottom: 15px;
        }
        .strategy-tabs .nav-link {
            color: #495057;
            border-radius: 5px 5px 0 0;
        }
        .strategy-tabs .nav-link.active {
            font-weight: bold;
            background-color: #6c5ce7;
            color: white;
        }
        .combination-tab .nav-link.active {
            background-color: #0984e3;
        }
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1,
        .markdown-content h2 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content ul {
            padding-left: 1.5rem;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .analysis-section {
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
            margin-top: 15px;
        }
        .nav-strategy-token {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-left: 5px;
        }
        .recommendation-type-tabs {
            margin-bottom: 20px;
        }
        .recommendation-type-tabs .nav-link {
            border-radius: 10px;
            margin-right: 10px;
            padding: 8px 16px;
            font-weight: 500;
        }
        .recommendation-type-tabs .nav-link.active {
            background-color: #6c5ce7;
            color: white;
        }
        .mode-combination .card-header {
            background-color: #0984e3;
        }
        .asset-checkbox {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <h1 class="text-center mb-4">DeFi Strategy Recommender</h1>

    <div class="alert alert-warning network-alert" id="network-alert">
        Please connect to Sonic Testnet to use this application.
        <button class="btn btn-sm btn-outline-dark ms-2" id="switch-network">
            Switch Network
        </button>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Connect Your Wallet</h5>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p id="wallet-status">Wallet not connected</p>
                    <p id="wallet-address" class="text-muted small"></p>
                    <p id="network-name" class="text-muted small"></p>
                </div>
                <button id="connect-wallet" class="btn btn-connect text-white">
                    Connect MetaMask
                </button>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Your Assets</h5>
        </div>
        <div class="card-body">
            <div id="assets-loading" class="text-center py-3">
                <p>Connect your wallet to view assets</p>
            </div>
            <div id="assets-container" class="d-none">
                <div class="alert alert-info mb-3">
                    <small>For combination strategy, check the assets you want to include.</small>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Select</th>
                            <th>Token</th>
                            <th>Balance</th>
                        </tr>
                        </thead>
                        <tbody id="assets-list">
                        <!-- Asset list will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Risk Preference</h5>
        </div>
        <div class="card-body">
            <select id="risk-level" class="form-select risk-selector">
                <option value="low">Low Risk (Conservative)</option>
                <option value="medium" selected>Medium Risk (Balanced)</option>
                <option value="high">High Risk (Aggressive)</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <button id="get-recommendations" class="btn btn-recommend text-white w-100" disabled>
                Get Individual Strategies
            </button>
        </div>
        <div class="col-md-6 mb-3">
            <button id="get-combination" class="btn btn-combination text-white w-100" disabled>
                Get Combination Strategy
            </button>
        </div>
    </div>

    <div id="loading" class="loading mt-4">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2" id="loading-text">
            Analyzing your portfolio and generating personalized recommendations...
        </p>
    </div>

    <div id="recommendation-type-container" class="mt-4 d-none">
        <ul class="nav nav-pills recommendation-type-tabs" id="recommendation-type-tabs">
            <li class="nav-item">
                <a
                        class="nav-link active"
                        id="individual-tab"
                        data-bs-toggle="pill"
                        href="#individual-content"
                >Individual Strategies</a
                >
            </li>
            <li class="nav-item">
                <a class="nav-link" id="combination-tab" data-bs-toggle="pill" href="#combination-content"
                >Combination Strategy</a
                >
            </li>
        </ul>
        <div class="tab-content" id="recommendation-type-content">
            <div class="tab-pane fade show active" id="individual-content">
                <div id="recommendations-container"></div>
            </div>
            <div class="tab-pane fade" id="combination-content">
                <div id="combination-container"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    // Sonic Testnet configuration
    const SONIC_CHAIN_ID = '0x92'; // 57054 in hexadecimal
    const SONIC_RPC_URL = 'rpc.soniclabs.com';
    const SONIC_NETWORK_NAME = 'Sonic Mainnet';

    // Token ABI for ERC-20 tokens
    const tokenABI = [
        {
            constant: true,
            inputs: [{ name: '_owner', type: 'address' }],
            name: 'balanceOf',
            outputs: [{ name: 'balance', type: 'uint256' }],
            type: 'function'
        },
        {
            constant: true,
            inputs: [],
            name: 'decimals',
            outputs: [{ name: '', type: 'uint8' }],
            type: 'function'
        },
        {
            constant: true,
            inputs: [],
            name: 'symbol',
            outputs: [{ name: '', type: 'string' }],
            type: 'function'
        }
    ];

    // Updated Sonic Testnet token addresses
    const tokenAddresses = {
          'wS': '0x039e2fB66102314Ce7b64Ce5Ce3E5183bc94aD38',
          'SACRA': '0x7ad5935ea295c4e743e4f2f5b4cda951f41223c2',
          'atETH': '0x284D81e48fBc782Aa9186a03a226690aEA5cBe0E',
          'scETH': '0x3bce5cb273f0f148010bbea2470e7b5df84c7812',
          'OS': '0xb1e25689d55734fd3fffc939c4c3eb52dff8a794',
          'wOS': '0x9F0dF7799f6FDAd409300080cfF680f5A23df4b1',
          'USDC': '0x29219dd400f2Bf60E5a23d13Be72B486D4038894',
          'scUSD': '0xd3dce716f3ef535c5ff8d041c1a41c3bd89b97ae',
          'EQUAL': '0xddf26b42c1d903de8962d3f79a74a501420d5f19',
          'TAILS': '0xaf3890e82befc1efc6538611fa4fb0ddb79fd04c',
          'BRUSH': '0xe51ee9868c1f0d6cd968a8b8c8376dc2991bfe44',
          'fSONIC': '0x05e31a691405d06708a355c029599c12d5da8b28',
          'sDOG': '0xaa87f3f135cf5856980ee4c49165fae64f6c33e3',
          'MOON': '0x486b6fa0419b33a0c7a6e4698c231d7e2f2d5299',
          'DONKS': '0x0a54364631ea37813a63edb3bba1c46f8d8304b2',
          'ECO': '0xa00da5cfbcf7a8fb9451ec170967e7d22f1a6ba7',
          'stS': '0xe5da20f15420ad15de0fa650600afc998bbe3955',
          'xSHADOW': '0x5050bc082ff4a74fb6b0b04385defddb114b2424',
          'INDI': '0x4EEC869d847A6d13b0F6D1733C5DEC0d1E741B4f',
          'FS': '0xBC0d0650412EF353D672c0Bbd12eFFF90591B251',
          'WETH': '0x50c42dEAcD8Fc9773493ED674b675bE577f2634b',
          'STBL': '0x78a76316F66224CBaCA6e70acB24D5ee5b2Bd2C7',
          'TYSG': '0x9b732365d6406c42e54c6b1d71cf835a257b350f',
          'GOGLZ': '0x3c5ba99108d44746b95ac9f4207176fe5d2458ab',
          'Missor': '0xf26b3fd147619df61d4c1d0a9f7200b31a73fafa',
          'SACRA_GEM_1': '0xfc0dd337b92baa949bc5d25fd9a99cb3b6873204',
          'fBOMB': '0xedf8b632b537d5993adb5e2e15882cd791c284cb',
          'EGGS': '0xf26ff70573ddc8a90bd7865af8d7d70b8ff019bc',
          'NAVI': '0x6881b80ea7c858e4aeef63893e18a8a36f3682f3',
        };


    // Backend API URLs
    const recommendApiUrl = 'http://localhost:4000/api/recommend';
    const combinationApiUrl = 'http://localhost:4000/api/combination';

    let web3;
    let userAccount;
    let userAssets = [];
    let currentChainId;
    let hasIndividualRecommendations = false;
    let hasCombinationRecommendation = false;

    // Check if connected to Sonic Testnet
    async function checkNetwork() {
        if (!window.ethereum) return false;

        try {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            currentChainId = chainId;

            if (chainId !== SONIC_CHAIN_ID) {
                document.getElementById('network-alert').style.display = 'block';
                document.getElementById('network-name').textContent = `Current Network: Not Sonic Testnet`;
                return false;
            } else {
                document.getElementById('network-alert').style.display = 'none';
                document.getElementById('network-name').textContent = `Network: ${SONIC_NETWORK_NAME}`;
                return true;
            }
        } catch (error) {
            console.error('Error checking network:', error);
            return false;
        }
    }

    // Switch to Sonic Testnet
    async function switchToSonicNetwork() {
        if (!window.ethereum) return;

        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: SONIC_CHAIN_ID }]
            });
        } catch (switchError) {
            if (switchError.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [
                            {
                                chainId: SONIC_CHAIN_ID,
                                chainName: SONIC_NETWORK_NAME,
                                nativeCurrency: {
                                    name: 'S',
                                    symbol: 'S',
                                    decimals: 18
                                },
                                rpcUrls: [SONIC_RPC_URL],
                                blockExplorerUrls: ['https://explorer.oasys.games/']
                            }
                        ]
                    });
                } catch (addError) {
                    console.error('Error adding Sonic network to MetaMask:', addError);
                }
            } else {
                console.error('Error switching to Sonic network:', switchError);
            }
        }
    }

    // Connect to MetaMask
    async function connectWallet() {
        if (window.ethereum) {
            try {
                web3 = new Web3(window.ethereum);
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];

                const isCorrectNetwork = await checkNetwork();

                document.getElementById('wallet-status').textContent = 'Wallet Connected';
                document.getElementById('wallet-address').textContent = `${userAccount.substring(0, 6)}...${userAccount.substring(38)}`;
                document.getElementById('connect-wallet').textContent = 'Connected';

                if (isCorrectNetwork) {
                    document.getElementById('get-recommendations').disabled = false;
                    document.getElementById('get-combination').disabled = false;
                    await getUserAssets();
                } else {
                    document.getElementById('get-recommendations').disabled = true;
                    document.getElementById('get-combination').disabled = true;
                }
            } catch (error) {
                console.error('Error connecting to MetaMask:', error);
                alert('Failed to connect to MetaMask. Please try again.');
            }
        } else {
            alert('MetaMask is not installed. Please install MetaMask to use this application.');
        }
    }

    // Get user assets from wallet
    async function getUserAssets() {
        document.getElementById('assets-loading').textContent = 'Loading your assets...';

        try {
            userAssets = [];

            // Get native S balance
            try {
                console.log(`Checking native S balance for address: ${userAccount}`);
                const sBalance = await web3.eth.getBalance(userAccount);
                console.log(`Native S raw balance: ${sBalance}`);

                const adjustedSBalance = web3.utils.fromWei(sBalance, 'ether');
                console.log(`Native S adjusted balance: ${adjustedSBalance}`);

                if (parseFloat(adjustedSBalance) > 0) {
                    userAssets.push({
                        name: 'sonic',
                        balance: parseFloat(parseFloat(adjustedSBalance).toFixed(4))
                    });
                }
            } catch (sError) {
                console.error('Error fetching native S balance:', sError);
            }

            // Check each ERC20 token balance
            for (const [tokenName, tokenAddress] of Object.entries(tokenAddresses)) {
                if (!tokenAddress) continue; // Skip tokens without an address
                try {
                    console.log(`Checking ${tokenName} token at address: ${tokenAddress}`);
                    const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);

                    // Get decimals
                    let tokenDecimals;
                    try {
                        tokenDecimals = await tokenContract.methods.decimals().call();
                        console.log(`${tokenName} token decimals: ${tokenDecimals}`);
                    } catch (decimalError) {
                        console.error(`Error getting ${tokenName} decimals, using default 18:`, decimalError);
                        tokenDecimals = 18;
                    }

                    // Get balance
                    const tokenBalance = await tokenContract.methods.balanceOf(userAccount).call();
                    console.log(`${tokenName} token raw balance: ${tokenBalance}`);

                    const adjustedTokenBalance = tokenBalance / Math.pow(10, tokenDecimals);
                    console.log(`${tokenName} token adjusted balance: ${adjustedTokenBalance}`);

                    if (adjustedTokenBalance > 0) {
                        userAssets.push({
                            name: tokenName,
                            balance: parseFloat(adjustedTokenBalance.toFixed(4))
                        });
                    }
                } catch (tokenError) {
                    console.error(`Error fetching ${tokenName} token balance:`, tokenError);
                }
            }

            // Display assets
            displayAssets();
        } catch (error) {
            console.error('Error fetching user assets:', error);
            document.getElementById('assets-loading').textContent = 'Failed to load assets. Please try again.';
        }
    }

    // Display user assets in the UI
    function displayAssets() {
        const assetsList = document.getElementById('assets-list');
        assetsList.innerHTML = '';

        if (userAssets.length === 0) {
            document.getElementById('assets-loading').textContent = 'No assets found in your wallet';
            return;
        }

        document.getElementById('assets-loading').classList.add('d-none');
        document.getElementById('assets-container').classList.remove('d-none');

        userAssets.forEach((asset, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
          <td>            <input type="checkbox" class="form-check-input asset-checkbox" id="asset-check-${index}" data-asset-index="${index}" checked>
          </td>          <td>${asset.name}</td>
          <td>${asset.balance}</td>
        `;
            assetsList.appendChild(row);
        });
    }

    // Get individual recommendations from API
    async function getRecommendations() {
        if (userAssets.length === 0) {
            alert('Please connect your wallet and ensure you have assets to get recommendations.');
            return;
        }

        const riskLevel = document.getElementById('risk-level').value;

        // Prepare request payload according to the expected format
        const payload = {
            wallet_balance: userAssets.map(asset => ({
                name: asset.name,
                balance: parseFloat(asset.balance.toFixed(4))
            })),
            risk: riskLevel
        };

        console.log('Sending individual recommendation request with payload:', payload);

        // Show loading indicator
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading-text').textContent = 'Analyzing your portfolio and generating individual strategies...';
        document.getElementById('recommendations-container').innerHTML = '';

        try {
            const response = await fetch(recommendApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API responded with status: ${response.status}`);
            }

            const responseData = await response.json();
            console.log('Received individual API response:', responseData);

            displayIntegratedRecommendations(responseData);
            hasIndividualRecommendations = true;

            // Show recommendation type tabs if both recommendation types are available
            updateRecommendationTypeTabs();

            // Activate individual tab
            const individualTab = document.getElementById('individual-tab');
            const individualTabBS = new bootstrap.Tab(individualTab);
            individualTabBS.show();
        } catch (error) {
            console.error('Error fetching individual recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = `
          <div class="alert alert-danger">            Failed to get individual recommendations. Please try again later.          </div>        `;
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // Get combination strategy recommendation
    async function getCombinationStrategy() {
        if (userAssets.length === 0) {
            alert('Please connect your wallet and ensure you have assets to get recommendations.');
            return;
        }

        // Get selected assets
        const selectedAssets = [];
        document.querySelectorAll('.asset-checkbox:checked').forEach(checkbox => {
            const assetIndex = parseInt(checkbox.getAttribute('data-asset-index'));
            if (!isNaN(assetIndex) && assetIndex >= 0 && assetIndex < userAssets.length) {
                selectedAssets.push(userAssets[assetIndex]);
            }
        });

        if (selectedAssets.length === 0) {
            alert('Please select at least one asset for the combination strategy.');
            return;
        }

        const riskLevel = document.getElementById('risk-level').value;

        // Prepare request payload
        const payload = {
            wallet_balance: selectedAssets.map(asset => ({
                name: asset.name,
                balance: parseFloat(asset.balance.toFixed(4))
            })),
            risk: riskLevel
        };

        console.log('Sending combination strategy request with payload:', payload);

        // Show loading indicator
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading-text').textContent = 'Analyzing your selected assets and generating a combination strategy...';
        document.getElementById('combination-container').innerHTML = '';

        try {
            const response = await fetch(combinationApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API responded with status: ${response.status}`);
            }

            const responseData = await response.json();
            console.log('Received combination API response:', responseData);

            displayCombinationRecommendation(responseData);
            hasCombinationRecommendation = true;

            // Show recommendation type tabs if both recommendation types are available
            updateRecommendationTypeTabs();

            // Activate combination tab
            const combinationTab = document.getElementById('combination-tab');
            const combinationTabBS = new bootstrap.Tab(combinationTab);
            combinationTabBS.show();
        } catch (error) {
            console.error('Error fetching combination strategy:', error);
            document.getElementById('combination-container').innerHTML = `
          <div class="alert alert-danger">            Failed to get combination strategy. Please try again later.          </div>        `;
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // Display integrated recommendations with AI analysis paired with strategy
    function displayIntegratedRecommendations(data) {
        const container = document.getElementById('recommendations-container');
        container.innerHTML = '';

        if (!data || (!data.ai_responses && !data.strategies)) {
            container.innerHTML = `
          <div class="alert alert-warning">            No recommendations available for your portfolio.          </div>        `;
            return;
        }

        if (
            !data.ai_responses ||
            !data.strategies ||
            data.ai_responses.length === 0 ||
            data.strategies.length === 0 ||
            data.ai_responses.length !== data.strategies.length
        ) {
            container.innerHTML = `
          <div class="alert alert-warning">            Incomplete recommendation data received.          </div>        `;
            return;
        }

        const recommendationsCard = document.createElement('div');
        recommendationsCard.className = 'card mb-4';

        const recommendationsHeader = document.createElement('div');
        recommendationsHeader.className = 'card-header';
        recommendationsHeader.innerHTML = '<h5 class="mb-0">Individual Asset Strategies</h5>';

        const recommendationsBody = document.createElement('div');
        recommendationsBody.className = 'card-body';

        const tabsNav = document.createElement('ul');
        tabsNav.className = 'nav nav-tabs strategy-tabs';
        tabsNav.id = 'recommendation-tabs';

        const tabContent = document.createElement('div');
        tabContent.className = 'tab-content mt-3';
        tabContent.id = 'recommendation-tab-content';

        const assetTokens = userAssets.map(asset => asset.name);

        data.strategies.forEach((strategy, index) => {
            const aiResponse = data.ai_responses[index];
            const assetName = index < assetTokens.length ? assetTokens[index] : `Asset ${index + 1}`;

            const tabNav = document.createElement('li');
            tabNav.className = 'nav-item';

            const tabLink = document.createElement('a');
            tabLink.className = index === 0 ? 'nav-link active' : 'nav-link';
            tabLink.href = `#recommendation-${index}`;
            tabLink.setAttribute('data-bs-toggle', 'tab');
            tabLink.innerHTML = `${assetName} Strategy <span class="nav-strategy-token">(${strategy.description.split(' ')[0]})</span>`;

            tabNav.appendChild(tabLink);
            tabsNav.appendChild(tabNav);

            const tabPane = document.createElement('div');
            tabPane.className = index === 0 ? 'tab-pane fade show active' : 'tab-pane fade';
            tabPane.id = `recommendation-${index}`;

            const aiAnalysisSection = document.createElement('div');
            aiAnalysisSection.className = 'ai-analysis mb-4';

            const parsedContent = marked.parse(aiResponse);
            const formattedContent = parsedContent
                .replace(/#green/g, '<span class="positive">')
                .replace(/#red/g, '<span class="negative">')
                .replace(/(<\/li>|<\/p>|<\/h[1-6]>)(?=\s*<span class="(positive|negative)">)/g, '$1</span>');

            aiAnalysisSection.innerHTML = `
          <h5>Investment Analysis</h5>          <div class="markdown-content">            ${formattedContent}
          </div>        `;
            tabPane.appendChild(aiAnalysisSection);

            const strategySection = document.createElement('div');
            strategySection.className = 'strategy-section mt-4';

            const strategyContent = `
          <h5>Strategy Details</h5>          <div class="card strategy-card">            <div class="card-body">              <h5 class="strategy-title">${strategy.description}</h5>
              <div class="mb-3">                <span class="badge ${strategy.risk_level === 'low' ? 'bg-success' : strategy.risk_level === 'medium' ? 'bg-warning' : 'bg-danger'}">
                  ${strategy.risk_level.charAt(0).toUpperCase() + strategy.risk_level.slice(1)} Risk                </span>                <span class="ms-2">Impermanent Loss: ${strategy.impermanent_loss}</span>
              </div>              <div class="row mb-4">                <div class="col-md-6">                  <h6>Yield Rates</h6>                  <table class="table table-sm table-bordered">                    <thead>                      <tr>                        <th>Metric</th>                        <th>Latest</th>                        <th>24h</th>                        <th>Week</th>                      </tr>                    </thead>                    <tbody>                      <tr>                        <td>Total APY</td>                        <td>${strategy.yield_rates.income['total apy'].latest}</td>
                        <td>${strategy.yield_rates.income['total apy']['24h']}</td>
                        <td>${strategy.yield_rates.income['total apy'].week}</td>
                      </tr>                      <tr>                        <td>Total APR</td>                        <td>${strategy.yield_rates.income['total apr'].latest}</td>
                        <td>${strategy.yield_rates.income['total apr']['24h']}</td>
                        <td>${strategy.yield_rates.income['total apr'].week}</td>
                      </tr>                      <tr>                        <td>Farm APR</td>                        <td>${strategy.yield_rates.income['farm apr'].latest}</td>
                        <td>${strategy.yield_rates.income['farm apr']['24h']}</td>
                        <td>${strategy.yield_rates.income['farm apr'].week}</td>
                      </tr>                    </tbody>                  </table>                </div>                <div class="col-md-6">                  <h6>VS HODL Performance</h6>                  <table class="table table-sm table-bordered">                    <thead>                      <tr>                        <th>Comparison</th>                        <th>24h</th>                        <th>Week</th>                        <th>57 Days</th>                      </tr>                    </thead>                    <tbody>                      ${strategy.yield_rates.vs_hold
                .map(
                    holdItem => `
                        <tr>                          <td>${holdItem.type}</td>
                          <td class="${holdItem.apr_24h.startsWith('+') ? 'positive' : 'negative'}">${holdItem.apr_24h}</td>
                          <td class="${holdItem.apr_week.startsWith('+') ? 'positive' : 'negative'}">${holdItem.apr_week}</td>
                          <td class="${holdItem.days_57.startsWith('+') ? 'positive' : 'negative'}">${holdItem.days_57}</td>
                        </tr>                      `                )
                .join('')}
                    </tbody>                  </table>                </div>              </div>              <h6>Price Changes (57 Days)</h6>              <table class="table table-sm table-bordered">                <thead>                  <tr>                    <th>Asset</th>                    <th>Initial Price</th>                    <th>Current Price</th>                    <th>Change</th>                  </tr>                </thead>                <tbody>                  ${strategy.yield_rates.prices
                .map(
                    price => `
                    <tr>                      <td>${price.token}</td>
                      <td>${price.init_price}</td>
                      <td>${price.price}</td>
                      <td class="${price.change_57_days.startsWith('+') ? 'positive' : price.change_57_days === '0.00%' ? '' : 'negative'}">${price.change_57_days}</td>
                    </tr>                  `                )
                .join('')}
                </tbody>              </table>              <div class="strategy-reasoning mt-3 p-3 bg-light rounded">                <h6>Risk Analysis</h6>                <p>${strategy.risk_reason}</p>
              </div>            </div>          </div>        `;
            strategySection.innerHTML = strategyContent;
            tabPane.appendChild(strategySection);

            tabContent.appendChild(tabPane);
        });

        recommendationsBody.appendChild(tabsNav);
        recommendationsBody.appendChild(tabContent);
        recommendationsCard.appendChild(recommendationsHeader);
        recommendationsCard.appendChild(recommendationsBody);
        container.appendChild(recommendationsCard);
    }

    // Display combination strategy recommendation

    // Display combination strategy recommendation
    function displayCombinationRecommendation(data) {
        const container = document.getElementById('combination-container');
        container.innerHTML = '';

        if (!data || (!data.ai_responses && !data.recommendations)) {
            container.innerHTML = `
          <div class="alert alert-warning">
            No combination strategy available for your selected assets.
          </div>
        `;
            return;
        }

        if (!data.recommendations || data.recommendations.length === 0) {
            container.innerHTML = `
          <div class="alert alert-warning">
            Incomplete combination strategy data received.
          </div>
        `;
            return;
        }

        const combinationCard = document.createElement('div');
        combinationCard.className = 'card mb-4 mode-combination';

        const combinationHeader = document.createElement('div');
        combinationHeader.className = 'card-header';
        combinationHeader.innerHTML = '<h5 class="mb-0">Combination Strategy</h5>';

        const combinationBody = document.createElement('div');
        combinationBody.className = 'card-body';

        // Selected assets section
        const selectedAssetsDiv = document.createElement('div');
        selectedAssetsDiv.className = 'selected-assets mb-4';

        const selectedAssets = [];
        document.querySelectorAll('.asset-checkbox:checked').forEach(checkbox => {
            const assetIndex = parseInt(checkbox.getAttribute('data-asset-index'));
            if (!isNaN(assetIndex) && assetIndex >= 0 && assetIndex < userAssets.length) {
                selectedAssets.push(userAssets[assetIndex]);
            }
        });

        selectedAssetsDiv.innerHTML = `
        <h6>Selected Assets</h6>
        <div class="d-flex flex-wrap gap-2 mb-3">
          ${selectedAssets
            .map(
                asset => `<span class="badge bg-info">${asset.name}: ${asset.balance}</span>`
            )
            .join('')}
        </div>
    `;
        combinationBody.appendChild(selectedAssetsDiv);

        // AI Analysis section - show all AI responses
        if (data.ai_responses && data.ai_responses.length > 0) {
            const aiAnalysisSection = document.createElement('div');
            aiAnalysisSection.className = 'ai-analysis mb-4';

            let aiResponsesHtml = '<h5>Combination Strategy Analysis</h5>';

            data.ai_responses.forEach((response, index) => {
                const parsedContent = marked.parse(response);
                const formattedContent = parsedContent
                    .replace(/#green/g, '<span class="positive">')
                    .replace(/#red/g, '<span class="negative">')
                    .replace(/(<\/li>|<\/p>|<\/h[1-6]>)(?=\s*<span class="(positive|negative)">)/g, '$1</span>');

                aiResponsesHtml += `
                <div class="markdown-content mb-3 ${index > 0 ? 'mt-4 pt-3 border-top' : ''}">
                    <h6>Strategy Component ${index + 1}</h6>
                    ${formattedContent}
                </div>
            `;
            });

            aiAnalysisSection.innerHTML = aiResponsesHtml;
            combinationBody.appendChild(aiAnalysisSection);
        }

        // Recommendations section
        const recommendationsSection = document.createElement('div');
        recommendationsSection.className = 'recommendations-section mt-4';
        recommendationsSection.innerHTML = '<h5>Recommended Strategy Combination</h5>';

        // Create tabs for multiple recommendations
        const tabsNav = document.createElement('ul');
        tabsNav.className = 'nav nav-tabs strategy-tabs combination-tab';
        tabsNav.id = 'combination-tabs';

        const tabContent = document.createElement('div');
        tabContent.className = 'tab-content mt-3';
        tabContent.id = 'combination-tab-content';

        data.recommendations.forEach((recommendation, index) => {
            const strategy = recommendation.strategy;

            // Tab navigation item
            const tabNav = document.createElement('li');
            tabNav.className = 'nav-item';

            const tabLink = document.createElement('a');
            tabLink.className = index === 0 ? 'nav-link active' : 'nav-link';
            tabLink.href = `#combination-${index}`;
            tabLink.setAttribute('data-bs-toggle', 'tab');
            tabLink.innerHTML = `Strategy ${index + 1} <span class="nav-strategy-token">(${strategy.description.split(' ')[0]})</span>`;

            tabNav.appendChild(tabLink);
            tabsNav.appendChild(tabNav);

            // Tab content
            const tabPane = document.createElement('div');
            tabPane.className = index === 0 ? 'tab-pane fade show active' : 'tab-pane fade';
            tabPane.id = `combination-${index}`;

            // Used assets section
            const usedAssetsDiv = document.createElement('div');
            usedAssetsDiv.className = 'used-assets mb-3';

            let usedAssetsHtml = '<h6>Assets Used</h6><div class="d-flex flex-wrap gap-2 mb-3">';
            recommendation.used_assets.forEach(([assetName, amount]) => {
                usedAssetsHtml += `<span class="badge bg-success">${assetName}: ${amount}</span>`;
            });
            usedAssetsHtml += '</div>';

            if (recommendation.vault_address) {
                usedAssetsHtml += `<p class="small text-muted">Vault Address: ${recommendation.vault_address}</p>`;
            }

            usedAssetsDiv.innerHTML = usedAssetsHtml;
            tabPane.appendChild(usedAssetsDiv);

            // Strategy details
            const strategyContent = `
        <div class="card strategy-card">
          <div class="card-body">
            <h5 class="strategy-title">${strategy.description}</h5>
            <div class="mb-3">
              <span class="badge ${strategy.risk_level === 'low' ? 'bg-success' : strategy.risk_level === 'medium' ? 'bg-warning' : 'bg-danger'}">
                ${strategy.risk_level.charAt(0).toUpperCase() + strategy.risk_level.slice(1)} Risk
              </span>
              <span class="ms-2">Impermanent Loss: ${strategy.impermanent_loss}</span>
            </div>
            <div class="row mb-4">
              <div class="col-md-6">
                <h6>Yield Rates</h6>
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th>Metric</th>
                      <th>Latest</th>
                      <th>24h</th>
                      <th>Week</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Total APY</td>
                      <td>${strategy.yield_rates.income['total apy'].latest}</td>
                      <td>${strategy.yield_rates.income['total apy']['24h']}</td>
                      <td>${strategy.yield_rates.income['total apy'].week}</td>
                    </tr>
                    <tr>
                      <td>Total APR</td>
                      <td>${strategy.yield_rates.income['total apr'].latest}</td>
                      <td>${strategy.yield_rates.income['total apr']['24h']}</td>
                      <td>${strategy.yield_rates.income['total apr'].week}</td>
                    </tr>
                    <tr>
                      <td>Farm APR</td>
                      <td>${strategy.yield_rates.income['farm apr'].latest}</td>
                      <td>${strategy.yield_rates.income['farm apr']['24h']}</td>
                      <td>${strategy.yield_rates.income['farm apr'].week}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="col-md-6">
                <h6>VS HODL Performance</h6>
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th>Comparison</th>
                      <th>24h</th>
                      <th>Week</th>
                      <th>57 Days</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${strategy.yield_rates.vs_hold
                .map(
                    holdItem => `
                      <tr>
                        <td>${holdItem.type}</td>
                        <td class="${holdItem.apr_24h.startsWith('+') ? 'positive' : 'negative'}">${holdItem.apr_24h}</td>
                        <td class="${holdItem.apr_week.startsWith('+') ? 'positive' : 'negative'}">${holdItem.apr_week}</td>
                        <td class="${holdItem.days_57.startsWith('+') ? 'positive' : 'negative'}">${holdItem.days_57}</td>
                      </tr>
                    `
                )
                .join('')}
                  </tbody>
                </table>
              </div>
            </div>
            <h6>Price Changes (57 Days)</h6>
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>Asset</th>
                  <th>Initial Price</th>
                  <th>Current Price</th>
                  <th>Change</th>
                </tr>
              </thead>
              <tbody>
                ${strategy.yield_rates.prices
                .map(
                    price => `
                  <tr>
                    <td>${price.token}</td>
                    <td>${price.init_price}</td>
                    <td>${price.price}</td>
                    <td class="${price.change_57_days.startsWith('+') ? 'positive' : price.change_57_days === '0.00%' ? '' : 'negative'}">${price.change_57_days}</td>
                  </tr>
                `
                )
                .join('')}
              </tbody>
            </table>
            <div class="strategy-reasoning mt-3 p-3 bg-light rounded">
              <h6>Risk Analysis</h6>
              <p>${strategy.risk_reason}</p>
            </div>
          </div>
        </div>
      `;
            tabPane.innerHTML += strategyContent;
            tabContent.appendChild(tabPane);
        });

        recommendationsSection.appendChild(tabsNav);
        recommendationsSection.appendChild(tabContent);
        combinationBody.appendChild(recommendationsSection);

        combinationCard.appendChild(combinationHeader);
        combinationCard.appendChild(combinationBody);
        container.appendChild(combinationCard);
    }


    // Update recommendation type tabs visibility
    function updateRecommendationTypeTabs() {
        const tabsContainer = document.getElementById('recommendation-type-container');

        if (hasIndividualRecommendations || hasCombinationRecommendation) {
            tabsContainer.classList.remove('d-none');
        } else {
            tabsContainer.classList.add('d-none');
        }

        const individualTab = document.getElementById('individual-tab');
        if (!hasIndividualRecommendations) {
            individualTab.classList.add('disabled');
        } else {
            individualTab.classList.remove('disabled');
        }

        const combinationTab = document.getElementById('combination-tab');
        if (!hasCombinationRecommendation) {
            combinationTab.classList.add('disabled');
        } else {
            combinationTab.classList.remove('disabled');
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('connect-wallet').addEventListener('click', connectWallet);
        document.getElementById('get-recommendations').addEventListener('click', getRecommendations);
        document.getElementById('get-combination').addEventListener('click', getCombinationStrategy);
        document.getElementById('switch-network').addEventListener('click', switchToSonicNetwork);

        if (window.ethereum) {
            checkNetwork();

            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    document.getElementById('wallet-status').textContent = 'Wallet not connected';
                    document.getElementById('wallet-address').textContent = '';
                    document.getElementById('connect-wallet').textContent = 'Connect MetaMask';
                    document.getElementById('get-recommendations').disabled = true;
                    document.getElementById('get-combination').disabled = true;
                    document.getElementById('assets-loading').textContent = 'Connect your wallet to view assets';
                    document.getElementById('assets-container').classList.add('d-none');
                    userAssets = [];
                    hasIndividualRecommendations = false;
                    hasCombinationRecommendation = false;
                    updateRecommendationTypeTabs();
                } else {
                    userAccount = accounts[0];
                    document.getElementById('wallet-address').textContent = `${userAccount.substring(0, 6)}...${userAccount.substring(38)}`;
                    checkNetwork().then(isCorrectNetwork => {
                        if (isCorrectNetwork) {
                            getUserAssets();
                        }
                    });
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                currentChainId = chainId;
                checkNetwork().then(isCorrectNetwork => {
                    if (isCorrectNetwork && userAccount) {
                        document.getElementById('get-recommendations').disabled = false;
                        document.getElementById('get-combination').disabled = false;
                        getUserAssets();
                    } else {
                        document.getElementById('get-recommendations').disabled = true;
                        document.getElementById('get-combination').disabled = true;
                    }
                });
            });
        }
    });
</script>
</body>
</html>