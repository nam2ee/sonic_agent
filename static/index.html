<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi Strategy Recommender</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 1000px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #6c5ce7;
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }
        .btn-connect {
            background-color: #6c5ce7;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
        }
        .btn-connect:hover {
            background-color: #5649c0;
        }
        .btn-recommend {
            background-color: #00b894;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
        }
        .btn-recommend:hover {
            background-color: #00a383;
        }
        .risk-selector {
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .asset-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .recommendation-card {
            background-color: #f1f9ff;
            border-left: 5px solid #6c5ce7;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            color: #6c5ce7;
        }
        .network-alert {
            display: none;
            margin-top: 20px;
        }
        .strategy-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        .strategy-card {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }
        .strategy-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .strategy-description {
            color: #6c757d;
        }
        .yield-rate {
            font-weight: bold;
            color: #28a745;
        }
        .risk-level {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .risk-low {
            background-color: #d4edda;
            color: #155724;
        }
        .risk-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        .risk-high {
            background-color: #f8d7da;
            color: #721c24;
        }
        .vs-hodl-positive {
            color: #28a745;
        }
        .vs-hodl-negative {
            color: #dc3545;
        }
        .strategy-tabs {
            margin-bottom: 15px;
        }
        .strategy-tabs .nav-link {
            color: #495057;
            border-radius: 5px 5px 0 0;
        }
        .strategy-tabs .nav-link.active {
            font-weight: bold;
            background-color: #6c5ce7;
            color: white;
        }
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1,
        .markdown-content h2 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content ul {
            padding-left: 1.5rem;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .analysis-section {
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
            margin-top: 15px;
        }
        .nav-strategy-token {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-left: 5px;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <h1 class="text-center mb-4">DeFi Strategy Recommender</h1>

    <div class="alert alert-warning network-alert" id="network-alert">
        Please connect to Sonic Testnet to use this application.
        <button class="btn btn-sm btn-outline-dark ms-2" id="switch-network">Switch Network</button>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Connect Your Wallet</h5>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p id="wallet-status">Wallet not connected</p>
                    <p id="wallet-address" class="text-muted small"></p>
                    <p id="network-name" class="text-muted small"></p>
                </div>
                <button id="connect-wallet" class="btn btn-connect text-white">
                    Connect MetaMask
                </button>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Your Assets</h5>
        </div>
        <div class="card-body">
            <div id="assets-loading" class="text-center py-3">
                <p>Connect your wallet to view assets</p>
            </div>
            <div id="assets-container" class="d-none">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Token</th>
                            <th>Balance</th>
                        </tr>
                        </thead>
                        <tbody id="assets-list">
                        <!-- Asset list will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Risk Preference</h5>
        </div>
        <div class="card-body">
            <select id="risk-level" class="form-select risk-selector">
                <option value="low">Low Risk (Conservative)</option>
                <option value="medium" selected>Medium Risk (Balanced)</option>
                <option value="high">High Risk (Aggressive)</option>
            </select>
        </div>
    </div>

    <div class="d-grid gap-2">
        <button id="get-recommendations" class="btn btn-recommend text-white" disabled>
            Get DeFi Recommendations
        </button>
    </div>

    <div id="loading" class="loading mt-4">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Analyzing your portfolio and generating personalized recommendations...</p>
    </div>

    <div id="recommendations-container" class="mt-4">
        <!-- Recommendations will be displayed here -->
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    // Sonic Testnet configuration
    const SONIC_CHAIN_ID = '0xdede'; // 57054 in hexadecimal
    const SONIC_RPC_URL = 'https://rpc.blaze.soniclabs.com';
    const SONIC_NETWORK_NAME = 'Sonic Testnet';

    // Token ABI for ERC-20 tokens
    const tokenABI = [
        {
            "constant": true,
            "inputs": [{"name": "_owner", "type": "address"}],
            "name": "balanceOf",
            "outputs": [{"name": "balance", "type": "uint256"}],
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "decimals",
            "outputs": [{"name": "", "type": "uint8"}],
            "type": "function"
        },
        {
            "constant": true,
            "inputs": [],
            "name": "symbol",
            "outputs": [{"name": "", "type": "string"}],
            "type": "function"
        }
    ];

    // Updated Sonic Testnet token addresses
    const tokenAddresses = {
        'sETH': '0x30BF3761147Ef0c86E2f84c3784FBD89E7954670',
        'USDC': '0xAF93888cbD250300470A1618206e036E11470149',
        'wETH': '0x50971F8978C431D560ff658a83a8a03fdf199055'
    };

    // Backend API URL
    const apiUrl = 'http://localhost:443/api/recommend';

    let web3;
    let userAccount;
    let userAssets = [];
    let currentChainId;

    // Check if connected to Sonic Testnet
    async function checkNetwork() {
        if (!window.ethereum) return false;

        try {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            currentChainId = chainId;

            if (chainId !== SONIC_CHAIN_ID) {
                document.getElementById('network-alert').style.display = 'block';
                document.getElementById('network-name').textContent = `Current Network: Not Sonic Testnet`;
                return false;
            } else {
                document.getElementById('network-alert').style.display = 'none';
                document.getElementById('network-name').textContent = `Network: ${SONIC_NETWORK_NAME}`;
                return true;
            }
        } catch (error) {
            console.error('Error checking network:', error);
            return false;
        }
    }

    // Switch to Sonic Testnet
    async function switchToSonicNetwork() {
        if (!window.ethereum) return;

        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: SONIC_CHAIN_ID }],
            });
        } catch (switchError) {
            // This error code indicates that the chain has not been added to MetaMask
            if (switchError.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [
                            {
                                chainId: SONIC_CHAIN_ID,
                                chainName: SONIC_NETWORK_NAME,
                                nativeCurrency: {
                                    name: 'S',
                                    symbol: 'S',
                                    decimals: 18
                                },
                                rpcUrls: [SONIC_RPC_URL],
                                blockExplorerUrls: ['https://explorer.oasys.games/']
                            },
                        ],
                    });
                } catch (addError) {
                    console.error('Error adding Sonic network to MetaMask:', addError);
                }
            } else {
                console.error('Error switching to Sonic network:', switchError);
            }
        }
    }

    // Connect to MetaMask
    async function connectWallet() {
        if (window.ethereum) {
            try {
                web3 = new Web3(window.ethereum);
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];

                const isCorrectNetwork = await checkNetwork();

                document.getElementById('wallet-status').textContent = 'Wallet Connected';
                document.getElementById('wallet-address').textContent = `${userAccount.substring(0, 6)}...${userAccount.substring(38)}`;
                document.getElementById('connect-wallet').textContent = 'Connected';

                if (isCorrectNetwork) {
                    document.getElementById('get-recommendations').disabled = false;
                    await getUserAssets();
                } else {
                    document.getElementById('get-recommendations').disabled = true;
                }
            } catch (error) {
                console.error('Error connecting to MetaMask:', error);
                alert('Failed to connect to MetaMask. Please try again.');
            }
        } else {
            alert('MetaMask is not installed. Please install MetaMask to use this application.');
        }
    }

    // Get user assets from wallet
    async function getUserAssets() {
        document.getElementById('assets-loading').textContent = 'Loading your assets...';

        try {
            userAssets = [];

            // Get native S balance
            try {
                console.log(`Checking native S balance for address: ${userAccount}`);
                const sBalance = await web3.eth.getBalance(userAccount);
                console.log(`Native S raw balance: ${sBalance}`);

                const adjustedSBalance = web3.utils.fromWei(sBalance, 'ether');
                console.log(`Native S adjusted balance: ${adjustedSBalance}`);

                if (parseFloat(adjustedSBalance) > 0) {
                    userAssets.push({
                        name: 'S',
                        balance: parseFloat(parseFloat(adjustedSBalance).toFixed(4))
                    });
                }
            } catch (sError) {
                console.error('Error fetching native S balance:', sError);
            }

            // Check each ERC20 token balance
            for (const [tokenName, tokenAddress] of Object.entries(tokenAddresses)) {
                try {
                    console.log(`Checking ${tokenName} token at address: ${tokenAddress}`);
                    const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);

                    // Get decimals
                    let tokenDecimals;
                    try {
                        tokenDecimals = await tokenContract.methods.decimals().call();
                        console.log(`${tokenName} token decimals: ${tokenDecimals}`);
                    } catch (decimalError) {
                        console.error(`Error getting ${tokenName} decimals, using default 18:`, decimalError);
                        tokenDecimals = 18;
                    }

                    // Get balance
                    const tokenBalance = await tokenContract.methods.balanceOf(userAccount).call();
                    console.log(`${tokenName} token raw balance: ${tokenBalance}`);

                    const adjustedTokenBalance = tokenBalance / Math.pow(10, tokenDecimals);
                    console.log(`${tokenName} token adjusted balance: ${adjustedTokenBalance}`);

                    if (adjustedTokenBalance > 0) {
                        userAssets.push({
                            name: tokenName,
                            balance: parseFloat(adjustedTokenBalance.toFixed(4))
                        });
                    }
                } catch (tokenError) {
                    console.error(`Error fetching ${tokenName} token balance:`, tokenError);
                }
            }

            // Display assets
            displayAssets();
        } catch (error) {
            console.error('Error fetching user assets:', error);
            document.getElementById('assets-loading').textContent = 'Failed to load assets. Please try again.';
        }
    }

    // Display user assets in the UI
    function displayAssets() {
        const assetsList = document.getElementById('assets-list');
        assetsList.innerHTML = '';

        if (userAssets.length === 0) {
            document.getElementById('assets-loading').textContent = 'No assets found in your wallet';
            return;
        }

        document.getElementById('assets-loading').classList.add('d-none');
        document.getElementById('assets-container').classList.remove('d-none');

        userAssets.forEach(asset => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${asset.name}</td>
              <td>${asset.balance}</td>
            `;
            assetsList.appendChild(row);
        });
    }

    // Get recommendations from API
    async function getRecommendations() {
        if (userAssets.length === 0) {
            alert('Please connect your wallet and ensure you have assets to get recommendations.');
            return;
        }

        const riskLevel = document.getElementById('risk-level').value;

        // Prepare request payload according to the expected format
        const payload = {
            wallet_balance: userAssets.map(asset => ({
                name: asset.name,
                balance: parseFloat(asset.balance.toFixed(4))
            })),
            risk: riskLevel
        };

        console.log('Sending recommendation request with payload:', payload);

        // Show loading indicator
        document.getElementById('loading').style.display = 'block';
        document.getElementById('recommendations-container').innerHTML = '';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API responded with status: ${response.status}`);
            }

            const responseData = await response.json();
            console.log('Received API response:', responseData);
            displayIntegratedRecommendations(responseData);
        } catch (error) {
            console.error('Error fetching recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = `
              <div class="alert alert-danger">
                Failed to get recommendations. Please try again later.
              </div>
            `;
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // Display integrated recommendations with AI analysis paired with strategy
    function displayIntegratedRecommendations(data) {
        const container = document.getElementById('recommendations-container');
        container.innerHTML = '';

        if (!data || (!data.ai_responses && !data.strategies)) {
            container.innerHTML = `
              <div class="alert alert-warning">
                No recommendations available for your portfolio.
              </div>
            `;
            return;
        }

        // Verify that we have both AI responses and strategies
        if (!data.ai_responses || !data.strategies ||
            data.ai_responses.length === 0 || data.strategies.length === 0 ||
            data.ai_responses.length !== data.strategies.length) {
            container.innerHTML = `
              <div class="alert alert-warning">
                Incomplete recommendation data received.
              </div>
            `;
            return;
        }

        // Create integrated recommendation display
        const recommendationsCard = document.createElement('div');
        recommendationsCard.className = 'card mb-4';

        const recommendationsHeader = document.createElement('div');
        recommendationsHeader.className = 'card-header';
        recommendationsHeader.innerHTML = '<h5 class="mb-0">Personalized Recommendations</h5>';

        const recommendationsBody = document.createElement('div');
        recommendationsBody.className = 'card-body';

        // Create tabs for each integrated recommendation
        const tabsNav = document.createElement('ul');
        tabsNav.className = 'nav nav-tabs strategy-tabs';
        tabsNav.id = 'recommendation-tabs';

        const tabContent = document.createElement('div');
        tabContent.className = 'tab-content mt-3';
        tabContent.id = 'recommendation-tab-content';

        // Map asset names to recommendations based on the order
        const assetTokens = userAssets.map(asset => asset.name);

        // Create tabs and content for each recommendation pair
        data.strategies.forEach((strategy, index) => {
            const aiResponse = data.ai_responses[index];
            const assetName = index < assetTokens.length ? assetTokens[index] : `Asset ${index + 1}`;

            // Create tab nav item
            const tabNav = document.createElement('li');
            tabNav.className = 'nav-item';

            const tabLink = document.createElement('a');
            tabLink.className = index === 0 ? 'nav-link active' : 'nav-link';
            tabLink.href = `#recommendation-${index}`;
            tabLink.setAttribute('data-bs-toggle', 'tab');
            tabLink.innerHTML = `${assetName} Strategy <span class="nav-strategy-token">(${strategy.description.split(' ')[0]})</span>`;

            tabNav.appendChild(tabLink);
            tabsNav.appendChild(tabNav);

            // Create tab content with both AI analysis and strategy details
            const tabPane = document.createElement('div');
            tabPane.className = index === 0 ? 'tab-pane fade show active' : 'tab-pane fade';
            tabPane.id = `recommendation-${index}`;

            // First, show the AI analysis
            const aiAnalysisSection = document.createElement('div');
            aiAnalysisSection.className = 'ai-analysis mb-4';

            // Parse markdown content
            const parsedContent = marked.parse(aiResponse);
            // Format special tags
            const formattedContent = parsedContent
                .replace(/#green/g, '<span class="positive">')
                .replace(/#red/g, '<span class="negative">')
                .replace(/(<\/li>|<\/p>|<\/h[1-6]>)(?=\s*<span class="(positive|negative)">)/g, '$1</span>');

            aiAnalysisSection.innerHTML = `
                <h5>Investment Analysis</h5>
                <div class="markdown-content">
                    ${formattedContent}
                </div>
            `;

            tabPane.appendChild(aiAnalysisSection);

            // Then, show the strategy details
            const strategySection = document.createElement('div');
            strategySection.className = 'strategy-section mt-4';

            const strategyContent = `
                <h5>Strategy Details</h5>
                <div class="card strategy-card">
                    <div class="card-body">
                        <h5 class="strategy-title">${strategy.description}</h5>
                        <div class="mb-3">
                            <span class="badge ${strategy.risk_level === 'low' ? 'bg-success' : strategy.risk_level === 'medium' ? 'bg-warning' : 'bg-danger'}">
                                ${strategy.risk_level.charAt(0).toUpperCase() + strategy.risk_level.slice(1)} Risk
                            </span>
                            <span class="ms-2">Impermanent Loss: ${strategy.impermanent_loss}</span>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Yield Rates</h6>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>Latest</th>
                                            <th>24h</th>
                                            <th>Week</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Total APY</td>
                                            <td>${strategy.yield_rates.income['total apy'].latest}</td>
                                            <td>${strategy.yield_rates.income['total apy']['24h']}</td>
                                            <td>${strategy.yield_rates.income['total apy'].week}</td>
                                        </tr>
                                        <tr>
                                            <td>Total APR</td>
                                            <td>${strategy.yield_rates.income['total apr'].latest}</td>
                                            <td>${strategy.yield_rates.income['total apr']['24h']}</td>
                                            <td>${strategy.yield_rates.income['total apr'].week}</td>
                                        </tr>
                                        <tr>
                                            <td>Farm APR</td>
                                            <td>${strategy.yield_rates.income['farm apr'].latest}</td>
                                            <td>${strategy.yield_rates.income['farm apr']['24h']}</td>
                                            <td>${strategy.yield_rates.income['farm apr'].week}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="col-md-6">
                                <h6>VS HODL Performance</h6>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Comparison</th>
                                            <th>24h</th>
                                            <th>Week</th>
                                            <th>57 Days</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${strategy.yield_rates.vs_hold.map(holdItem => `
                                            <tr>
                                                <td>${holdItem.type}</td>
                                                <td class="${holdItem.apr_24h.startsWith('+') ? 'positive' : 'negative'}">${holdItem.apr_24h}</td>
                                                <td class="${holdItem.apr_week.startsWith('+') ? 'positive' : 'negative'}">${holdItem.apr_week}</td>
                                                <td class="${holdItem.days_57.startsWith('+') ? 'positive' : 'negative'}">${holdItem.days_57}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <h6>Price Changes (57 Days)</h6>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Asset</th>
                                    <th>Initial Price</th>
                                    <th>Current Price</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${strategy.yield_rates.prices.map(price => `
                                    <tr>
                                        <td>${price.token}</td>
                                        <td>${price.init_price}</td>
                                        <td>${price.price}</td>
                                        <td class="${price.change_57_days.startsWith('+') ? 'positive' : price.change_57_days === '0.00%' ? '' : 'negative'}">${price.change_57_days}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="strategy-reasoning mt-3 p-3 bg-light rounded">
                            <h6>Risk Analysis</h6>
                            <p>${strategy.risk_reason}</p>
                        </div>
                    </div>
                </div>
            `;

            strategySection.innerHTML = strategyContent;
            tabPane.appendChild(strategySection);

            tabContent.appendChild(tabPane);
        });

        recommendationsBody.appendChild(tabsNav);
        recommendationsBody.appendChild(tabContent);

        recommendationsCard.appendChild(recommendationsHeader);
        recommendationsCard.appendChild(recommendationsBody);

        container.appendChild(recommendationsCard);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('connect-wallet').addEventListener('click', connectWallet);
        document.getElementById('get-recommendations').addEventListener('click', getRecommendations);
        document.getElementById('switch-network').addEventListener('click', switchToSonicNetwork);

        // Check network on page load
        if (window.ethereum) {
            checkNetwork();

            // Listen for account changes
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // User disconnected wallet
                    document.getElementById('wallet-status').textContent = 'Wallet not connected';
                    document.getElementById('wallet-address').textContent = '';
                    document.getElementById('connect-wallet').textContent = 'Connect MetaMask';
                    document.getElementById('get-recommendations').disabled = true;
                    document.getElementById('assets-loading').textContent = 'Connect your wallet to view assets';
                    document.getElementById('assets-container').classList.add('d-none');
                    userAssets = [];
                } else {
                    // User switched account
                    userAccount = accounts[0];
                    document.getElementById('wallet-address').textContent = `${userAccount.substring(0, 6)}...${userAccount.substring(38)}`;
                    checkNetwork().then(isCorrectNetwork => {
                        if (isCorrectNetwork) {
                            getUserAssets();
                        }
                    });
                }
            });

            // Listen for chain changes
            window.ethereum.on('chainChanged', (chainId) => {
                currentChainId = chainId;
                checkNetwork().then(isCorrectNetwork => {
                    if (isCorrectNetwork && userAccount) {
                        document.getElementById('get-recommendations').disabled = false;
                        getUserAssets();
                    } else {
                        document.getElementById('get-recommendations').disabled = true;
                    }
                });
            });
        }
    });
</script>
</body>
</html>